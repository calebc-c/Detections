title: ToolShell Exploit Chain and Web Shell Deployment
description: |
  Detects activity related to the ToolShell SharePoint exploit chain (CVE-2025-53770). Including authentication bypass,
  web shell uploads, credential dumping, reflective code loading, and Command and control activity.

author: Caleb C.
date: July 21, 2025
references:
  - https://www.varonis.com/blog/toolshell-sharepoint-rce
  - https://www.trendmicro.com/en_us/research/25/g/cve-2025-53770-and-cve-2025-53771-sharepoint-attacks.html
  - https://nvd.nist.gov/vuln/detail/CVE-2025-53770
  - https://attack.mitre.org/techniques/T1190/
  - https://attack.mitre.org/techniques/T1505/003/
  - https://attack.mitre.org/techniques/T1003/
  - https://attack.mitre.org/techniques/T1071/001/
  - https://attack.mitre.org/techniques/T1620/

logsource:
  category: multiple
  product: windows
  service: various
  definition: |
    Includes IIS web logs, Windows security logs, Sysmon, PowerShell logs, and network traffic logs.

# URI Patterns
detection:
  selection_iis_exploit:
    cs-uri-stem|contains: "/_layouts/15/ToolPane.aspx" # Threat actor POST method
    cs-uri-query|contains: "DisplayMode=Edit"
    cs-uri-query|contains: "/_layouts/15/upload.aspx"
    cs-method:
      - POST
      - PUT
      - OPTIONS

  selection_iis_uploads:
    cs-uri-stem|endswith: 
     - ".aspx"
     - "dll"
     - ".exe"
     - ".ps1"
    cs-uri-stem|contains:
      - "spinstall"
      - "upload"
    cs-method:
      - POST
      - PUT
      - OPTIONS

  # Identifies LSASS memory dump attempts, often used to extract credentials
  selection_sysmon_lsass_dump:
    EventID: 1
    Image|endswith:
      - '\procdump.exe'
      - '\rundll32.exe'
      - 'powershell.exe'
    CommandLine|contains:
      - 'lsass'
      - 'MiniDumpWriteDump'
      - 'createfile'
      - 'writefile'

 # Grouped PowerShell detection for script-based code injection â€” all three patterns commonly used in in-memory or obfuscated attacks.
  selection_sysmon_code_injection:
    EventID: 1
    CommandLine|contains:
      - 'IEX'
      - 'FromBase64String'
      - 'Invoke-Expression'
      - 'Invoke-Command'
    ParentImage|endswith: 'powershell.exe'

# Detects use of the C# compiler (csc.exe), which may indicate dynamic .NET assembly compilation by attackers
  selection_sysmon_compiler:
    EventID: 1
    Image|endswith: '\csc.exe'

# Detects for suspicious PowerShell script for script-based attacks (exection, strings and network operation)
  selection_powershell_logs:
    EventID: 4104
    ScriptBlockText|contains:
      # Execution Methods
      - 'IEX'
      - 'FromBase64String'
      - 'Invoke-Expression'
      - 'Start-Process'
      # Malicious Strings
      - 'hidden'
      - 'noprofile'
      - 'unrestricted'
      # Network Operation
      - DownloadString
      - 'DownloadFile'

  selection_webshell_execution:
    EventID: 4688
    ParentProcessName|endswith: 'w3wp.exe'
    NewProcessName|endswith:
      - '\cmd.exe'
      - '\powershell.exe'

# Monitors outbound POST traffic to .aspx endpoints often used for web-based command-and-control channels.
  selection_network_web_c2:
    dest_port:
      - 80
      - 443
    protocol: tcp
    uri_path|contains:
      - '.aspx'
      - 'cmd='
      - 'shell'
    method: POST

  condition: selection_iis_exploit or selection_iis_uploads or selection_sysmon_lsass_dump or selection_sysmon_code_injection or selection_sysmon_compiler or selection_powershell_logs or selection_webshell_execution or selection_network_web_c2

fields:
  - cs-uri-stem
  - cs-uri-query
  - cs-method
  - CommandLine
  - Image
  - ParentImage
  - ParentProcessName
  - NewProcessName
  - ScriptBlockText
  - dest_port
  - uri_path
  - protocol
  - user
  - host
  - SourceIp
  - DestinationIp
  - EventID

tags:
  - attack.initial_access
  - attack.T1190           # Exploit Public-Facing Application
  - attack.persistence
  - attack.T1505.003       # Server Software Component: Web Shell
  - attack.credential_access
  - attack.T1003           # OS Credential Dumping
  - attack.defense_evasion
  - attack.T1620           # Reflective Code Loading
  - attack.execution
  - attack.command_and_control
  - attack.T1071.001       # Application Layer Protocol: Web
  - attack.scripting
  - attack.T1059.001       # PowerShell
  - attack.T1059.003       # Windows Command Shell
  - attack.t1047           # WMI (if rundll32/wmiprvse interaction seen)

level: critical
